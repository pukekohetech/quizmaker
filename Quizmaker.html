<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quiz JSON Builder for BCATS Safety Assessments</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; line-height: 1.5; }
  h1, h2 { color: #2c3e50; }
  label { display: block; margin-top: 12px; font-weight: bold; }
  input, textarea, select { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
  textarea { height: 100px; }
  .section { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 8px; background: #f9f9f9; }
  .question, .teacher, .rubric-row, .option-row { border: 1px solid #ccc; padding: 12px; margin: 10px 0; background: white; border-radius: 5px; position: relative; }
  .remove { float: right; color: red; cursor: pointer; }
  button { padding: 10px 20px; margin: 10px 5px 10px 0; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
  button:hover { background: #2980b9; }
  .add-btn { background: #27ae60; }
  .add-btn:hover { background: #1e8449; }
  .controls { margin: 20px 0; }
</style>
</head>
<body>

<h1>Quiz JSON Builder – BCATS Safety Assessments</h1>

<div class="section">
  <h2>General Information</h2>
  <label>APP_ID <input type="text" id="appId" value="US24352_SAFETY"></label>
  <label>VERSION <input type="text" id="version" value="2025"></label>
  <label>APP_TITLE <input type="text" id="appTitle" value="US 24352 – Safety Knowledge"></label>
  <label>APP_SUBTITLE <input type="text" id="appSubtitle" value="PHS - L1 Building – Assessment"></label>

  <label>Deadline Day <input type="number" id="deadlineDay" value="17"></label>
  <label>Deadline Month <input type="number" id="deadlineMonth" value="12"></label>
  <label>Deadline Label <input type="text" id="deadlineLabel" value="Submission deadline"></label>
</div>

<div class="section">
  <h2>Teachers</h2>
  <div id="teachers"></div>
  <button type="button" class="add-btn" onclick="addTeacher()">+ Add Teacher</button>
</div>

<div class="section">
  <h2>Assessments</h2>
  <div id="assessments"></div>
  <button type="button" class="add-btn" onclick="addAssessment()">+ Add Assessment</button>
</div>

<div class="controls">
  <input type="file" id="jsonFile" accept="application/json">
  <button type="button" onclick="loadJSONFile()">Load JSON File</button>
  <button type="button" onclick="generateJSON()">Download JSON File</button>
</div>

<script>
// ---------- Data structure ----------
let data = {
  APP_ID: "US24352_SAFETY",
  VERSION: "2025",
  APP_TITLE: "US 24352 – Safety Knowledge",
  APP_SUBTITLE: "PHS - L1 Building – Assessment",
  DEADLINE: { day: 17, month: 12, label: "Submission deadline" },
  TEACHERS: [],
  ASSESSMENTS: []
};

// ---------- Teachers ----------
function addTeacher(t = null) {
  const div = document.createElement('div');
  div.className = 'teacher';
  div.innerHTML = `
    <span class="remove" onclick="this.parentElement.remove()">✖</span>
    <label>ID <input type="text" class="tId" value="${t ? (t.id || '') : ''}"></label>
    <label>Name <input type="text" class="tName" value="${t ? (t.name || '') : ''}"></label>
    <label>Email <input type="text" class="tEmail" value="${t ? (t.email || '') : ''}"></label>
  `;
  document.getElementById('teachers').appendChild(div);
}

function collectTeachers() {
  data.TEACHERS = Array.from(document.querySelectorAll('.teacher')).map(d => ({
    id: d.querySelector('.tId').value.trim(),
    name: d.querySelector('.tName').value.trim(),
    email: d.querySelector('.tEmail').value.trim()
  }));
}

// ---------- Assessments & Questions ----------
function addAssessment(a = null) {
  const div = document.createElement('div');
  div.className = 'section';
  div.innerHTML = `
    <h2>Assessment</h2>
    <span class="remove" onclick="this.parentElement.parentElement.remove()">✖ Remove Assessment</span>
    <label>Assessment ID <input type="text" class="assId" value="${a ? (a.id || '') : ''}"></label>
    <label>Title <input type="text" class="assTitle" value="${a ? (a.title || '') : ''}"></label>
    <label>Subtitle <input type="text" class="assSubtitle" value="${a ? (a.subtitle || '') : ''}"></label>
    <div class="questions"></div>
    <button type="button" class="add-btn" onclick="addQuestion(this.closest('.section').querySelector('.questions'))">+ Add Question</button>
  `;
  document.getElementById('assessments').appendChild(div);
  if (a && a.questions) a.questions.forEach(q => addQuestion(div.querySelector('.questions'), q));
}

function addQuestion(container, q = null) {
  const div = document.createElement('div');
  div.className = 'question';
  div.innerHTML = `
    <span class="remove" onclick="this.parentElement.remove()">✖</span>
    <label>Question ID <input type="text" class="qId" value="${q ? (q.id || '') : ''}"></label>
    <label>Text (you can use \\n for line breaks)<br>
      <textarea class="qText">${q ? (q.text || '') : ''}</textarea></label>
    <label>Image filename (or blank.jpg) <input type="text" class="qImage" value="${q ? (q.image || 'blank.jpg') : 'blank.jpg'}"></label>
    <label>Hint <input type="text" class="qHint" value="${q ? (q.hint || '') : ''}"></label>
    <label>Type 
      <select class="qType" onchange="toggleOptionsRubric(this)">
        <option value="mc" ${q && q.type === 'mc' ? 'selected' : ''}>Multiple Choice (mc)</option>
        <option value="short" ${q && q.type === 'short' ? 'selected' : ''}>Short answer</option>
        <option value="long" ${q && q.type === 'long' ? 'selected' : ''}>Long answer</option>
      </select>
    </label>
    <label>Max Points <input type="number" class="qPoints" value="${q ? (q.maxPoints || 1) : 1}"></label>

    <div class="options" style="display:block">
      <h4>Options</h4>
      <div class="option-list"></div>
      <button type="button" class="add-btn" onclick="addOptionRow(this.closest('.options').querySelector('.option-list'))">+ Add Option</button>
    </div>

    <div class="rubric" style="display:block">
      <h4>Auto-grading Rubric</h4>
      <div class="rubric-list"></div>
      <button type="button" class="add-btn" onclick="addRubricRow(this.closest('.rubric').querySelector('.rubric-list'))">+ Add Rubric Rule</button>
    </div>
  `;
  container.appendChild(div);

  // ---- Options: populate for MC / create default for new question ----
  const optContainer = div.querySelector('.option-list');
  if (q && q.type === 'mc' && Array.isArray(q.options)) {
    let correctIndex = -1;
    if (q.rubric && q.rubric.length > 0 && q.rubric[0].check) {
      const pattern = q.rubric[0].check.toLowerCase();
      correctIndex = q.options.findIndex(o => pattern.includes((o || '').toLowerCase()));
    }
    q.options.forEach((optText, idx) => {
      addOptionRow(optContainer, {
        text: optText,
        correct: idx === correctIndex
      });
    });
  } else if (!q) {
    // New question: start with one empty option
    addOptionRow(optContainer);
  }

  // ---- Rubric: only for non-MC questions ----
  const rubricList = div.querySelector('.rubric-list');
  if (q && q.rubric && q.type !== 'mc') {
    q.rubric.forEach(r => addRubricRow(rubricList, r));
  } else if (!q || (q && q.type !== 'mc')) {
    addRubricRow(rubricList); // at least one empty row for non-MC
  }

  // Ensure correct show/hide on initial load
  const select = div.querySelector('.qType');
  toggleOptionsRubric(select);
}

function toggleOptionsRubric(select) {
  const qDiv = select.closest('.question');
  const isMc = select.value === 'mc';
  const optionsDiv = qDiv.querySelector('.options');
  const rubricDiv = qDiv.querySelector('.rubric');

  if (optionsDiv) optionsDiv.style.display = isMc ? 'block' : 'none';
  if (rubricDiv) rubricDiv.style.display = isMc ? 'none' : 'block';
}

// ---------- Options (MC answers) ----------
function addOptionRow(container, opt = null) {
  const div = document.createElement('div');
  div.className = 'option-row';
  div.innerHTML = `
    <span class="remove" onclick="this.parentElement.remove()">✖</span>
    <label>Option text
      <input type="text" class="optText" value="${opt ? (opt.text || opt) : ''}">
    </label>
    <label>
      <input type="checkbox" class="optCorrect" ${opt && opt.correct ? 'checked' : ''}>
      Correct answer
    </label>
  `;
  container.appendChild(div);
}

// ---------- Rubric rows (with easy keywords) ----------
function addRubricRow(container, r = null) {
  const div = document.createElement('div');
  div.className = 'rubric-row';
  div.innerHTML = `
    <span class="remove" onclick="this.parentElement.remove()">✖</span>
    <label>Points
      <input type="number" class="rPoints" value="${r ? (r.points || 1) : 1}">
    </label>

    <label>Easy keywords/phrases (comma separated)
      <input type="text" class="rEasy" placeholder="e.g. struck in the eye, flying particles, objects">
    </label>

    <label>Regex check (advanced, optional)
      <input type="text" class="rCheck" value="${r ? (r.check || '') : ''}">
    </label>

    <label>Flags (usually &quot;i&quot;)
      <input type="text" class="rFlags" value="${r ? (r.flags || 'i') : 'i'}">
    </label>
  `;
  container.appendChild(div);
}

// ---------- Collect everything for export ----------
function collectAll() {
  // General fields
  data.APP_ID = document.getElementById('appId').value.trim();
  data.VERSION = document.getElementById('version').value.trim();
  data.APP_TITLE = document.getElementById('appTitle').value.trim();
  data.APP_SUBTITLE = document.getElementById('appSubtitle').value.trim();
  data.DEADLINE = data.DEADLINE || {};
  data.DEADLINE.day = parseInt(document.getElementById('deadlineDay').value) || 1;
  data.DEADLINE.month = parseInt(document.getElementById('deadlineMonth').value) || 1;
  data.DEADLINE.label = document.getElementById('deadlineLabel').value.trim();

  collectTeachers();

  // Assessments
  data.ASSESSMENTS = Array.from(document.querySelectorAll('#assessments > .section')).map(assDiv => {
    const questions = Array.from(assDiv.querySelectorAll('.question')).map(qDiv => {
      const type = qDiv.querySelector('.qType').value;
      const maxPoints = parseInt(qDiv.querySelector('.qPoints').value) || 1;

      const question = {
        id: qDiv.querySelector('.qId').value.trim(),
        text: qDiv.querySelector('.qText').value.replace(/\n/g, '\n'),
        image: qDiv.querySelector('.qImage').value.trim() || "blank.jpg",
        hint: qDiv.querySelector('.qHint').value.trim(),
        type: type,
        maxPoints: maxPoints,
        rubric: []
      };

      if (type === 'mc') {
        // Collect options
        const optRows = Array.from(qDiv.querySelectorAll('.option-row'));
        const options = optRows
          .map(r => r.querySelector('.optText').value.trim())
          .filter(o => o);

        question.options = options;

        // Correct option from first checked row
        const correctRow = optRows.find(r => r.querySelector('.optCorrect').checked);
        if (correctRow) {
          const correctText = correctRow.querySelector('.optText').value.trim();
          if (correctText) {
            const escaped = correctText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            question.rubric = [{
              points: maxPoints,
              check: escaped,
              flags: 'i'
            }];
          }
        }
      } else {
        // Short/long questions use easy keywords -> regex OR manual regex
        const rubric = Array.from(qDiv.querySelectorAll('.rubric-row')).map(row => {
          const points = parseInt(row.querySelector('.rPoints').value) || 1;
          let check = row.querySelector('.rCheck').value.trim();
          const flags = row.querySelector('.rFlags').value.trim() || 'i';
          const easyInput = row.querySelector('.rEasy') ? row.querySelector('.rEasy').value.trim() : '';

          // If no manual regex but easy keywords are given, build regex:
          // requires ALL phrases, in any order: (?=.*phrase1)(?=.*phrase2).* 
          if (!check && easyInput) {
            const parts = easyInput.split(',').map(s => s.trim()).filter(Boolean);
            if (parts.length) {
              const pieces = parts.map(p => {
                const escaped = p.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                return `(?=.*${escaped})`;
              });
              check = pieces.join('') + '.*';
            }
          }

          return { points, check, flags };
        });

        question.rubric = rubric.filter(r => r.check); // remove empty rules
      }

      return question;
    });

    return {
      id: assDiv.querySelector('.assId').value.trim(),
      title: assDiv.querySelector('.assTitle').value.trim(),
      subtitle: assDiv.querySelector('.assSubtitle').value.trim(),
      questions: questions
    };
  });
}

// ---------- Generate & Download JSON ----------
function generateJSON() {
  collectAll();
  const jsonString = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonString], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${data.APP_ID}_v${data.VERSION}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// ---------- Load JSON from file ----------
function loadJSONFile() {
  const input = document.getElementById('jsonFile');
  const file = input.files[0];
  if (!file) {
    alert('Please choose a JSON file first.');
    return;
  }

  const reader = new FileReader();
  reader.onload = e => {
    try {
      const obj = JSON.parse(e.target.result);
      loadFromData(obj);
    } catch (err) {
      console.error(err);
      alert('Invalid JSON file.');
    }
  };
  reader.readAsText(file);
}

// ---------- Populate UI from a data object ----------
function loadFromData(obj) {
  if (!obj || typeof obj !== 'object') {
    alert('JSON does not look like a quiz data object.');
    return;
  }

  data = obj; // keep a copy

  // General
  document.getElementById('appId').value = obj.APP_ID || '';
  document.getElementById('version').value = obj.VERSION || '';
  document.getElementById('appTitle').value = obj.APP_TITLE || '';
  document.getElementById('appSubtitle').value = obj.APP_SUBTITLE || '';

  const deadline = obj.DEADLINE || {};
  document.getElementById('deadlineDay').value = deadline.day || 1;
  document.getElementById('deadlineMonth').value = deadline.month || 1;
  document.getElementById('deadlineLabel').value = deadline.label || '';

  // Teachers
  const tContainer = document.getElementById('teachers');
  tContainer.innerHTML = '';
  (obj.TEACHERS || []).forEach(t => addTeacher(t));

  // Assessments
  const aContainer = document.getElementById('assessments');
  aContainer.innerHTML = '';
  (obj.ASSESSMENTS || []).forEach(a => addAssessment(a));
}

// ---------- Initial setup ----------
addTeacher({id:"RY", name:"Mr Reynolds", email:"ry@pukekohehigh.school.nz"});
addTeacher({id:"RNR", name:"Mr Ranson", email:"rnr@pukekohehigh.school.nz"});
addTeacher({id:"Other", name:"Other Teacher", email:"technology@pukekohehigh.school.nz"});

addAssessment(); // empty one to start adding questions
</script>

</body>
</html>
